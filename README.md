# Spring User Banking

## Обзор

Spring User Banking – это RESTful приложение для управления пользователями и проведения безопасных банковских операций. Система обеспечивает:

- Управление данными пользователя (контакты, аккаунты)
- Аутентификацию через JWT
- Банковские переводы между аккаунтами с валидацией и потокозащитой
- Периодическое обновление баланса пользователей

## Используемые пакеты

- **Java 11:** Платформа для разработки приложения
- **Spring Boot (2.7.18):** Фреймворк для создания микросервисов и упрощения конфигурации.
- **Spring Data JPA:** ORM-решение для взаимодействия с PostgreSQL.
- **Spring Security:** Для реализации аутентификации и авторизации на основе JWT.
- **JJWT:** Библиотека для создания и проверки JWT-токенов.
- **PostgreSQL Driver:** Драйвер для подключения к базе данных PostgreSQL.
- **Flyway (или Liquibase):** Управление миграциями базы данных.
- **Swagger (Springfox/Springdoc):** Документирование REST API.
- **Spring Boot Starter Data Redis:** Реализация кэширования с использованием Redis.
- **Maven:** Инструмент для сборки проекта и управления зависимостями.
- **Testcontainers:** Интеграционное тестирование с использованием контейнеров (например, PostgreSQL).
- **Spring Boot Starter Test:** Набор инструментов для unit и интеграционного тестирования.

---

## Github Hooks

Данный репозиторий использует настраиваемые Git-хуки, расположенные в каталоге `hooks`, для автоматизации работы с сообщениями коммитов.

```sh
 git config core.hooksPath hooks
```

 Хук `prepare-commit-msg` автоматически добавляет название текущей ветки в начало сообщения коммита, обеспечивая прозрачное ведение истории изменений. Убедитесь, что файлы хуков имеют права на выполнение.

---

## Запуск проекта с помощью Docker

1. **Сборка и запуск контейнеров:**
   Выполните команду для сборки образов и запуска всех сервисов в фоне:

   ```bash
   docker-compose up --build -d
   ```

2. **Просмотр логов приложения:**  
   Для отслеживания логов используйте:

   ```bash
   docker-compose logs -f app
   ```

3. **Перезапуск приложения:**  
   Для перезапуска только приложения:

   ```bash
   docker-compose restart app
   ```

4. **Остановка сервисов:**  

   Остановить и удалить контейнеры можно командой:

   ```bash
   docker-compose down
   ```

---

## Вопросы для уточнения

### Общие вопросы по бизнес-логике и требованиям

- **Пользователи и данные:**
  - Как планируется формировать пользователей через миграции? Есть ли требование к синхронизации или обновлению этих данных в будущем?
  - Требуется ли валидация на уровне базы данных (например, уникальные ограничения) помимо валидации на уровне API?
- **Операции с данными:**
  - Какие конкретно поля и логика обновления данных разрешены для пользователей? Возможны ли сценарии, когда данные изменяет администратор?

### Вопросы по системному дизайну и архитектуре

- **Слой транзакций и целостность данных:**
  - Какие гарантии целостности данных требуются для банковских операций (например, перевод денег)? Планируется ли использование распределённых транзакций или достаточно транзакционности базы данных?
- **Периодическое обновление баланса:**
  - Должна ли задача обновления баланса выполняться в единственном экземпляре (например, с использованием leader election) или допускается параллельное выполнение в распределённой среде?
- **Аутентификация и безопасность:**
  - Требуется ли поддержка дополнительных мер безопасности, помимо JWT (например, ограничение по IP)?
  - Нужно ли ограничивать количество запросов для предотвращения DDoS-атак или злоупотреблений API?

### Вопросы по нагрузке и масштабируемости

- **Ожидаемая нагрузка:**
  - Какой предполагается объём одновременных пользователей и транзакций в системе? Есть ли прогнозируемые пиковые нагрузки?
  - Есть ли требования по времени отклика для критичных операций (например, банковский перевод)?
- **Производительность и масштабирование:**
  - Будет ли использоваться кэширование для снижения нагрузки на базу данных? Какие данные подходят для кэширования (например, результаты поиска пользователей, аутентификационные токены)?
  
### Обновление Java

- Рассматривается ли обновление версии Java до не менее чем Java 17 для повышения безопасности, производительности и улучшения поддержки современных функций языка?

---

## Swagger Документация и Примечания

В проекте реализована документация REST API с использованием Swagger. По умолчанию, Swagger доступен по адресу:

[http://localhost:8080/swagger-ui.html](http://localhost:8080/swagger-ui.html)

**Важно:**  
Для генерации документации используется зависимость `io.springfox` версии **2.9.2**, которая является устаревшей и содержит следующие уязвимости:

- **CVE-2019-17495** – оценка 9.8: Cross-Site Scripting (XSS)
- **CVE-2018-25031** – оценка 4.3: Insecure Storage of Sensitive Information
- **CVE-2024-38820** – оценка 3.1: Transitive Improper Handling of Case Sensitivity

Кроме того, при использовании версии **2.9.2** требуется добавить в `application.properties` следующую настройку:

```
spring.mvc.pathmatch.matching-strategy=ant_path_matcher
```

Это необходимо для обеспечения совместимости, так как по умолчанию Spring Boot использует новый механизм сопоставления путей, который несовместим с данной версией Springfox.

**Рекомендация:**  
Перед запуском в прод удалить зависимость `io.springfox` из проекта.

---

## Структура проекта

```
spring-user-banking/
├── .github/
│   └── workflows/
│       └── ci.yml                  # GitHub Actions CI configuration
├── src/
│   ├── main/
│   │   ├── java/
│   │   │   └── com/example/userbanking/
│   │   │       ├── Application.java
│   │   │       ├── config/
│   │   │       │   ├── DatabaseConfig.java
│   │   │       │   ├── RedisConfig.java
│   │   │       │   ├── SwaggerConfig.java
│   │   │       │   └── SecurityConfig.java
│   │   │       ├── controller/
│   │   │       │   ├── UserController.java
│   │   │       │   ├── AuthController.java
│   │   │       │   └── AccountController.java
│   │   │       ├── dto/
│   │   │       │   ├── UserDto.java
│   │   │       │   ├── AccountDto.java
│   │   │       │   ├── TransferRequest.java
│   │   │       │   └── AuthRequest.java
│   │   │       ├── exception/
│   │   │       │   ├── GlobalExceptionHandler.java
│   │   │       │   └── CustomException.java
│   │   │       ├── model/
│   │   │       │   ├── User.java
│   │   │       │   ├── Account.java
│   │   │       │   ├── EmailData.java
│   │   │       │   └── PhoneData.java
│   │   │       ├── repository/
│   │   │       │   ├── UserRepository.java
│   │   │       │   ├── AccountRepository.java
│   │   │       │   ├── EmailDataRepository.java
│   │   │       │   └── PhoneDataRepository.java
│   │   │       ├── security/
│   │   │       │   ├── JwtTokenProvider.java
│   │   │       │   └── JwtAuthenticationFilter.java
│   │   │       ├── service/
│   │   │       │   ├── UserService.java
│   │   │       │   ├── AccountService.java
│   │   │       │   └── TransferService.java
│   │   │       └── scheduler/
│   │   │           └── BalanceUpdateScheduler.java
│   │   └── resources/
│   │       ├── application.properties
│   │       └── db/migration/       # Миграции для создания таблиц
│   └── test/
│       └── java/com/example/userbanking/
│           ├── controller/UserControllerTest.java
│           └── service/TransferServiceTest.java
├── Dockerfile
├── docker-compose.yml
├── pom.xml
└── README.md
```
